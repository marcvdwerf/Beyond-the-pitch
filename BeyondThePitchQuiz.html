<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beyond The Pitch ‚Äî Quiz</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { 
      -webkit-font-smoothing: antialiased; 
      -moz-osx-font-smoothing: grayscale; 
    }
    .card-selected { 
      border-color: #e85d35; 
      background: #FFF7F1; 
    }
    .fade-in {
      animation: fadeIn 0.3s ease-in;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    .error-border {
      border-color: #ef4444 !important;
    }
  </style>
</head>
<body class="bg-[#1a1a2e] text-white min-h-screen">
<header class="max-w-4xl mx-auto px-4 py-4">
  <a href="https://travelbeyondthepitch.com" class="inline-flex items-center gap-3">
    <img 
      src="https://raw.githubusercontent.com/marcvdwerf/Beyond-the-pitch/refs/heads/main/images/beyond%20the%20pitch%20logo.jpg" 
      alt="Travel Beyond The Pitch"
      class="h-8 w-auto"
    />
  </a>
</header>

<div id="quiz-root" class="min-h-screen"></div>

<script>
(function () {
  const STORAGE_KEY = 'btp_quiz_state';
  
  const root = document.getElementById('quiz-root');

  const steps = [
    {
      id: 'intro',
      type: 'intro',
      title: 'Discover Your Perfect Sport & Culture Journey',
      subtitle: 'Travel beyond the stadium. Dive into communities, traditions and untold stories.',
      description: 'Experience sport the way locals do‚Äîfrom ancient Gaelic games in Irish villages to the electric passion of Lima\'s football culture.',
      stat: 'Co-created with local clubs, fans and communities'
    },
    {
      id: 'pilot',
      type: 'projects',
      title: 'Which destination speaks to you?',
      subtitle: 'Our current experiences',
      options: [
        {
          value: 'ireland',
          country: 'Ireland',
          title: 'Gaelic games',
          image: 'üáÆüá™',
          description: 'Ancient Irish sports, traditional pub culture, and rolling countryside',
          vibe: ['Authentic', 'Cultural', 'Community'],
          highlight: 'Experience hurling & Gaelic football with locals'
        },
        {
          value: 'lima',
          country: 'Peru',
          title: 'Alianza Lima',
          image: 'üáµüá™',
          description: 'South American football passion, world-class cuisine, and Pacific vibes',
          vibe: ['Vibrant', 'Passionate', 'Culinary'],
          highlight: 'Feel the intensity of Lima football culture'
        },
        {
          value: 'mongolia',
          country: 'Mongolia',
          title: 'Naadam Festival',
          image: 'üá≤üá≥',
          description: 'Wrestling, archery, horse racing in vast steppes with nomadic traditions',
          vibe: ['Epic', 'Adventurous', 'Unique'],
          highlight: 'Witness centuries-old warrior sports'
        }
      ]
    },
    {
      id: 'interests',
      type: 'multi-select',
      title: 'What makes travel meaningful to you?',
      subtitle: 'Select all that resonate',
      options: [
        { value: 'sport', label: 'Live Sport', icon: '‚öΩ' },
        { value: 'food', label: 'Local Cuisine', icon: 'üçú' },
        { value: 'culture', label: 'Deep Culture', icon: 'üèõÔ∏è' },
        { value: 'nightlife', label: 'Nightlife', icon: 'üåô' },
        { value: 'locals', label: 'Meet Locals', icon: 'ü§ù' },
        { value: 'language', label: 'Language', icon: 'üí¨' },
        { value: 'nature', label: 'Nature', icon: 'üèîÔ∏è' },
        { value: 'photography', label: 'Photography', icon: 'üì∏' }
      ]
    },
    {
      id: 'sport',
      type: 'single-select',
      title: 'Your sport preference?',
      options: [
        { value: 'football-major', label: 'Football (Major Leagues)', desc: 'Top-tier clubs & stadiums' },
        { value: 'football-local', label: 'Football (Local Culture)', desc: 'Community clubs & authenticity' },
        { value: 'traditional', label: 'Traditional Sports', desc: 'Indigenous & cultural sports' },
        { value: 'basketball', label: 'Basketball', desc: 'NBA, EuroLeague, street culture' },
        { value: 'rugby', label: 'Rugby', desc: 'Six Nations, local clubs' },
        { value: 'combat', label: 'Combat Sports', desc: 'Boxing, MMA, traditional martial arts' },
        { value: 'open', label: 'Open to Anything', desc: 'Surprise me with unique experiences' }
      ]
    },
    {
      id: 'travelStyle',
      type: 'cards',
      title: 'Your travel style?',
      options: [
        { value: 'immersive', label: 'Immersive Explorer', icon: 'üéí', desc: 'Deep local experiences, authentic connections, budget-conscious', budget: '‚Ç¨400-700' },
        { value: 'balanced', label: 'Balanced Adventurer', icon: 'üß≥', desc: 'Mix of comfort and local culture, curated experiences', budget: '‚Ç¨700-1200' },
        { value: 'premium', label: 'Premium Traveler', icon: '‚ú®', desc: 'Comfort-first with exclusive access and personalized touches', budget: '‚Ç¨1200+' }
      ]
    },
    {
      id: 'group',
      type: 'single-select',
      title: 'Who are you traveling with?',
      options: [
        { value: 'solo', label: 'Solo', desc: 'Flying solo, open to meeting others' },
        { value: 'couple', label: 'Partner', desc: 'Traveling as a couple' },
        { value: 'friends', label: 'Friends Group', desc: '2-6 friends' },
        { value: 'family', label: 'Family', desc: 'Family adventure' },
        { value: 'corporate', label: 'Corporate/Team', desc: 'Team building or corporate trip' }
      ]
    },
    {
      id: 'timing',
      type: 'quick-select',
      title: 'When are you looking to travel?',
      options: [
        'Next 3 months',
        'Next 6 months',
        'This year',
        'Just exploring'
      ]
    },
    {
      id: 'future',
      type: 'multi-select',
      title: 'What would you love to see next?',
      subtitle: 'Help shape our next journeys',
      options: [
        { value: 'derbies', label: 'Football Derbies', icon: '‚öΩ' },
        { value: 'basketball', label: 'Basketball', icon: 'üèÄ' },
        { value: 'europe', label: 'Europe', icon: 'üèâ' },
        { value: 'balkans', label: 'Balkans', icon: 'üá∑üá∏' },
        { value: 'latam', label: 'Latin America', icon: 'üåé' },
        { value: 'africa', label: 'Africa', icon: 'üåç' },
        { value: 'asia', label: 'Central Asia', icon: 'üèîÔ∏è' },
        { value: 'traditional', label: 'Indigenous Sports', icon: 'üé™' }
      ]
    },
    {
      id: 'contact',
      type: 'email',
      title: 'Get Your Personalized Journey',
      subtitle: 'Receive your match + exclusive early-bird access',
      fields: [
        { id: 'email', label: 'Email', type: 'email', required: true, placeholder: 'you@example.com' },
        { id: 'age', label: 'Age Range', type: 'select', required: true, options: ['18-24', '25-34', '35-44', '45-54', '55+'] },
        { id: 'location', label: 'Where are you from?', type: 'text', required: false, placeholder: 'City, Country' }
      ]
    }
  ];

  const recommendations = {
    ireland: {
      title: 'Ireland - Gaelic Games Experience',
      flag: 'üáÆüá™',
      tagline: 'Where Ancient Sport Meets Warm Hospitality',
      description: 'Based on your preferences, Ireland offers the perfect blend of authentic sport culture, community connection, and immersive local experiences.',
      highlights: [
        'Experience hurling and Gaelic football with local clubs',
        'Traditional pub sessions with players and locals',
        'Explore Irish countryside and coastal beauty',
        'Learn basic Irish phrases and sport terminology'
      ],
      whatsIncluded: ['Match tickets', 'Local guide', 'Traditional meals', 'Pub experiences', 'Cultural workshops'],
      testimonial: 'An unforgettable experience. The locals welcomed us like family. - Marc, Netherlands'
    },
    lima: {
      title: 'Lima - Alianza Lima Football',
      flag: 'üáµüá™',
      tagline: 'Where Football Passion Fuels a City',
      description: 'Your answers point to Lima - a destination where intense football culture meets world-renowned cuisine and vibrant nightlife.',
      highlights: [
        "Feel the electricity of South American football",
        "Culinary tour through Lima's food scene",
        "Experience Peruvian nightlife with locals",
        "Visit historic neighborhoods and markets"
      ],
      whatsIncluded: ['Stadium experience', 'Food tours', 'Local host', 'City exploration', 'Nightlife access'],
      testimonial: 'The passion at the stadium gave me goosebumps everytime. Lima exceeded all expectations. - Jos√©, Local guide and lifelong Alianza fan'
    },
    mongolia: {
      title: 'Mongolia - Naadam Festival',
      flag: 'üá≤üá≥',
      tagline: 'An Epic Journey Into Warrior Traditions',
      description: "You are drawn to the extraordinary. Mongolia's Naadam Festival offers an adventure unlike anything else - ancient sports in vast landscapes.",
      highlights: [
        'Witness traditional wrestling, archery, and horse racing',
        'Stay with nomadic families in the steppe',
        'Experience centuries-old warrior culture',
        'Explore Ulaanbaatar and endless grasslands'
      ],
      whatsIncluded: ['Festival access', 'Nomadic homestay', 'Cultural guide', 'Traditional meals', 'Nature experiences'],
      testimonial: 'Life-changing. The festival and landscapes are beyond words. - Thomas, Germany'
    }
  };

  let currentStep = 0;
  const answers = {};
  let isSubmitting = false;
  let showResult = false;
  let submitError = null;

  /***********************
   * SUPABASE CONFIG
   ***********************/
  const SUPABASE_URL = 'https://gdcybinerowhffccmlws.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdkY3liaW5lcm93aGZmY2NtbHdzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcxNzI5MDAsImV4cCI6MjA4Mjc0ODkwMH0.5IkIcup-QpAuZgpeq0Upl7HakYepaizhV4BcPZmtE0E';

  const supabase = window.supabase.createClient(
    SUPABASE_URL,
    SUPABASE_ANON_KEY
  );

  /***********************
   * SAVE QUIZ TO SUPABASE
   ***********************/
  async function saveQuizToSupabase() {
    const payload = {
      email: answers.email || null,
      age: answers.age || null,
      location: answers.location || null,
      pilot: answers.pilot || null,
      interests: answers.interests || [],
      sport: answers.sport || null,
      travel_style: answers.travelStyle || null,
      group_type: answers.group || null,
      timing: answers.timing || null,
      future: answers.future || [],
      raw_answers: answers
    };

    const { error } = await supabase
      .from('quiz_results')
      .insert([payload]);

    if (error) {
      console.error('Supabase error:', error);
      throw new Error('Unable to save data. Please try again.');
    }
  }

  // Load saved state
  function loadState() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const state = JSON.parse(saved);
        Object.assign(answers, state.answers || {});
        currentStep = state.currentStep || 0;
      }
    } catch (e) {
      console.error('Failed to load state:', e);
    }
  }

  // Save state
  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        answers,
        currentStep,
        timestamp: Date.now()
      }));
    } catch (e) {
      console.error('Failed to save state:', e);
    }
  }

  // Clear state
  function clearState() {
    try {
      localStorage.removeItem(STORAGE_KEY);
    } catch (e) {
      console.error('Failed to clear state:', e);
    }
  }

  function progressPercent() {
    const totalSteps = steps.length - 2; // Exclude intro and contact
    const current = Math.max(0, currentStep - 1);
    return Math.round((current / totalSteps) * 100);
  }

  function canProceedForStep(step) {
    if (!step) return false;
    if (step.type === 'intro') return true;
    if (step.type === 'email') {
      return answers.email && isValidEmail(answers.email) && answers.age;
    }
    if (step.type === 'multi-select') {
      return Array.isArray(answers[step.id]) && answers[step.id].length > 0;
    }
    return answers[step.id] !== undefined && answers[step.id] !== null && answers[step.id] !== '';
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function esc(s) { 
    return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); 
  }

  function goToStep(stepIndex) {
    if (stepIndex < 0 || stepIndex >= steps.length) return;
    currentStep = stepIndex;
    saveState();
    render();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function nextStep() {
    goToStep(currentStep + 1);
  }

  function prevStep() {
    goToStep(currentStep - 1);
  }

  function render() {
    if (showResult) {
      renderResult();
      return;
    }

    const step = steps[currentStep];
    if (!step) return;

    // üéØ SMART FADE-IN: Track current step ID
    const previousStepId = root.dataset.currentStepId;
    const isActualStepChange = previousStepId !== step.id;
    root.dataset.currentStepId = step.id;

    const showProgress = step.type !== 'intro';
    const canGoBack = currentStep > 1;

    root.innerHTML = `
      <div class="max-w-4xl mx-auto px-4 py-8 ${isActualStepChange ? 'fade-in' : ''}">
        ${showProgress ? `
          <div class="mb-6">
            <div class="flex justify-between items-center mb-3">
              <span class="text-xs text-gray-400">Step ${currentStep} of ${steps.length - 1}</span>
              <span class="text-xs text-gray-400">${progressPercent()}%</span>
            </div>
            <div class="w-full bg-gray-700 rounded-full h-2">
              <div class="bg-[#e85d35] h-2 rounded-full transition-all duration-300" style="width:${progressPercent()}%"></div>
            </div>
          </div>
        ` : ''}

        <div class="bg-white text-gray-900 rounded-2xl p-6 mb-6 shadow-xl">
          <div class="mb-4">
            <h2 class="text-2xl md:text-3xl font-bold mb-2">${esc(step.title)}</h2>
            ${step.subtitle ? `<p class="text-sm text-gray-600">${esc(step.subtitle)}</p>` : ''}
          </div>

          <div id="step-content"></div>
        </div>

        <div id="step-controls" class="flex items-center gap-4">
          ${canGoBack ? `
            <button id="back-btn" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-semibold transition">
              ‚Üê Back
            </button>
          ` : ''}
        </div>
      </div>
    `;

    const content = document.getElementById('step-content');
    const controls = document.getElementById('step-controls');

    if (canGoBack) {
      document.getElementById('back-btn')?.addEventListener('click', prevStep);
    }

    renderStepContent(step, content);
  }

  function renderStepContent(step, content) {
    if (step.type === 'intro') {
      content.innerHTML = `
        <div class="text-center space-y-6">
          <p class="text-xl md:text-2xl text-gray-700 font-light leading-relaxed">
            ${esc(step.subtitle)}
          </p>
          
          <p class="text-base text-gray-600 max-w-2xl mx-auto">
            ${esc(step.description)}
          </p>

          <div class="flex items-center justify-center gap-3 text-gray-500 py-4">
            <div class="text-3xl">üèÜ</div>
            <span class="text-sm font-medium">${esc(step.stat)}</span>
          </div>

          <div class="pt-4">
            <button id="begin-btn" class="px-10 py-4 bg-[#e85d35] hover:bg-[#d14d25] rounded-xl font-bold text-white text-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">
              Start Your Journey ‚Üí
            </button>
            <p class="text-sm text-gray-400 mt-4">Takes 2-3 minutes ‚Ä¢ 9 simple questions</p>
          </div>
        </div>
      `;
      document.getElementById('begin-btn').addEventListener('click', nextStep);
      return;
    }

    if (step.type === 'projects') {
      content.innerHTML = step.options.map(opt => {
        const selected = answers[step.id] === opt.value;
        return `
          <button type="button" data-value="${esc(opt.value)}" 
            class="w-full text-left p-4 rounded-xl mb-3 transition-all border-2 ${selected ? 'card-selected' : 'hover:border-gray-300'}">
            <div class="flex items-start gap-4">
              <div class="text-4xl">${opt.image}</div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-1">
                  <h3 class="font-bold">${esc(opt.country)}</h3>
                  <span class="text-sm text-[#e85d35]">${esc(opt.title)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">${esc(opt.description)}</p>
                <div class="flex gap-2 flex-wrap mb-2">
                  ${opt.vibe.map(t => `<span class="px-2 py-1 bg-gray-100 rounded-full text-xs text-gray-800">${esc(t)}</span>`).join('')}
                </div>
                <p class="text-xs text-gray-500 italic">${esc(opt.highlight)}</p>
              </div>
            </div>
          </button>
        `;
      }).join('');

      content.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener('click', () => {
          answers[step.id] = btn.getAttribute('data-value');
          saveState();
          setTimeout(nextStep, 300);
        });
      });
      return;
    }

    // üéØ MULTI-SELECT WITHOUT RE-RENDER
    if (step.type === 'multi-select') {
      content.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-4" id="multi-grid">
          ${step.options.map(opt => {
            const selected = Array.isArray(answers[step.id]) && answers[step.id].includes(opt.value);
            return `
              <button type="button" data-value="${esc(opt.value)}" 
                class="p-3 border-2 rounded-xl text-center transition-all ${selected ? 'card-selected' : 'hover:border-gray-300'}">
                <div class="text-2xl mb-1">${opt.icon}</div>
                <div class="text-sm font-medium">${esc(opt.label)}</div>
              </button>
            `;
          }).join('')}
        </div>

        <button id="multi-continue" 
          class="w-full py-3 bg-[#e85d35] hover:bg-[#d14d25] rounded-xl text-white font-bold transition ${canProceedForStep(step) ? '' : 'btn-disabled'}">
          Continue ‚Üí
        </button>
      `;

      // ‚úÖ Direct DOM manipulation - NO re-render
      content.querySelectorAll('#multi-grid button').forEach(btn => {
        btn.addEventListener('click', () => {
          const v = btn.getAttribute('data-value');
          
          // Initialize array if needed
          if (!Array.isArray(answers[step.id])) {
            answers[step.id] = [];
          }
          
          const arr = answers[step.id];
          const idx = arr.indexOf(v);
          
          // Toggle selection
          if (idx >= 0) {
            arr.splice(idx, 1);
            btn.classList.remove('card-selected');
          } else {
            arr.push(v);
            btn.classList.add('card-selected');
          }
          
          saveState();
          
          // ‚úÖ Update button state DIRECTLY
          const continueBtn = document.getElementById('multi-continue');
          if (arr.length > 0) {
            continueBtn.classList.remove('btn-disabled');
          } else {
            continueBtn.classList.add('btn-disabled');
          }
        });
      });

      document.getElementById('multi-continue')?.addEventListener('click', () => {
        if (canProceedForStep(step)) nextStep();
      });
      return;
    }

    if (step.type === 'single-select') {
      content.innerHTML = step.options.map(opt => {
        const selected = answers[step.id] === opt.value;
        return `
          <button type="button" data-value="${esc(opt.value)}" 
            class="w-full p-4 rounded-xl mb-3 text-left border-2 transition-all ${selected ? 'card-selected' : 'hover:border-gray-300'}">
            <div class="font-semibold">${esc(opt.label)}</div>
            <div class="text-sm text-gray-600">${esc(opt.desc)}</div>
          </button>
        `;
      }).join('');

      content.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener('click', () => {
          answers[step.id] = btn.getAttribute('data-value');
          saveState();
          setTimeout(nextStep, 300);
        });
      });
      return;
    }

    if (step.type === 'cards') {
      content.innerHTML = `
        <div class="grid md:grid-cols-3 gap-3">
          ${step.options.map(opt => {
            const selected = answers[step.id] === opt.value;
            return `
              <button type="button" data-value="${esc(opt.value)}" 
                class="p-4 rounded-xl text-center border-2 transition-all ${selected ? 'card-selected' : 'hover:border-gray-300'}">
                <div class="text-3xl mb-2">${opt.icon}</div>
                <div class="font-bold mb-1">${esc(opt.label)}</div>
                <div class="text-sm text-gray-600 mb-2">${esc(opt.desc)}</div>
                <div class="text-xs text-gray-500">${esc(opt.budget)}</div>
              </button>
            `;
          }).join('')}
        </div>
      `;

      content.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener('click', () => {
          answers[step.id] = btn.getAttribute('data-value');
          saveState();
          setTimeout(nextStep, 300);
        });
      });
      return;
    }

    if (step.type === 'quick-select') {
      content.innerHTML = `
        <div class="grid grid-cols-2 gap-3">
          ${step.options.map(opt => {
            const selected = answers[step.id] === opt;
            return `
              <button type="button" data-value="${esc(opt)}" 
                class="p-4 border-2 rounded-xl font-semibold transition-all ${selected ? 'card-selected' : 'hover:border-gray-300'}">
                ${esc(opt)}
              </button>
            `;
          }).join('')}
        </div>
      `;

      content.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener('click', () => {
          answers[step.id] = btn.getAttribute('data-value');
          saveState();
          setTimeout(nextStep, 300);
        });
      });
      return;
    }

    // üéØ EMAIL VALIDATION WITHOUT RE-RENDER
    if (step.type === 'email') {
      content.innerHTML = `
        <div class="bg-orange-50 border-l-4 border-[#e85d35] p-4 rounded mb-4">
          <div class="font-semibold text-[#e85d35]">Get early bird access to our limited-capacity journeys</div>
          <div class="text-sm text-gray-600">Plus your personalized travel guide</div>
        </div>

        <div id="error-container" class="hidden bg-red-50 border-l-4 border-red-500 p-4 rounded mb-4">
          <div class="font-semibold text-red-800">Something went wrong</div>
          <div id="error-message" class="text-sm text-red-600"></div>
        </div>

        <form id="contact-form" class="space-y-4">
          ${step.fields.map(f => {
            const value = answers[f.id] || '';
            
            if (f.type === 'select') {
              return `
                <div>
                  <label class="block text-sm font-medium mb-2">${esc(f.label)} ${f.required ? '<span class="text-red-500">*</span>' : ''}</label>
                  <select name="${esc(f.id)}" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-sm focus:border-[#e85d35] focus:outline-none transition">
                    <option value="">Select...</option>
                    ${f.options.map(opt => `
                      <option value="${esc(opt)}" ${value === opt ? 'selected' : ''}>${esc(opt)}</option>
                    `).join('')}
                  </select>
                </div>
              `;
            } else {
              return `
                <div>
                  <label class="block text-sm font-medium mb-2">${esc(f.label)} ${f.required ? '<span class="text-red-500">*</span>' : ''}</label>
                  <input name="${esc(f.id)}" type="${esc(f.type)}" 
                    value="${esc(value)}"
                    placeholder="${esc(f.placeholder || '')}" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-sm focus:border-[#e85d35] focus:outline-none transition" />
                  <p class="error-text text-xs text-red-500 mt-1 hidden"></p>
                </div>
              `;
            }
          }).join('')}

          <button type="submit" id="submit-btn" 
            class="w-full py-3 bg-[#e85d35] hover:bg-[#d14d25] rounded-xl text-white font-bold transition ${canProceedForStep(step) ? '' : 'btn-disabled'}">
            See My Journey ‚Üí
          </button>
          
          <p class="text-xs text-gray-500 text-center mt-3">We respect your privacy. Unsubscribe anytime.</p>
        </form>
      `;

      const form = document.getElementById('contact-form');
      const submitBtn = document.getElementById('submit-btn');
      
      // ‚úÖ Real-time validation WITHOUT re-render
      function validateForm() {
        let isValid = true;
        
        step.fields.forEach(f => {
          const field = form.querySelector(`[name="${f.id}"]`);
          const value = field.value.trim();
          const errorText = field.parentElement.querySelector('.error-text');
          
          // Clear previous errors
          if (errorText) {
            errorText.classList.add('hidden');
            errorText.textContent = '';
          }
          field.classList.remove('error-border');
          
          // Validate required fields
          if (f.required && !value) {
            isValid = false;
            if (errorText) {
              errorText.textContent = `${f.label} is required`;
              errorText.classList.remove('hidden');
            }
            field.classList.add('error-border');
          }
          
          // Email validation
          if (f.id === 'email' && value && !isValidEmail(value)) {
            isValid = false;
            if (errorText) {
              errorText.textContent = 'Please enter a valid email address';
              errorText.classList.remove('hidden');
            }
            field.classList.add('error-border');
          }
        });
        
        // ‚úÖ Update button state DIRECTLY
        if (isValid) {
          submitBtn.classList.remove('btn-disabled');
        } else {
          submitBtn.classList.add('btn-disabled');
        }
        
        return isValid;
      }
      
      // Real-time field validation
      form.querySelectorAll('input, select').forEach(field => {
        field.addEventListener('input', (e) => {
          const fieldId = e.target.name;
          answers[fieldId] = e.target.value.trim();
          saveState();
          
          // ‚úÖ Validate WITHOUT re-render
          validateForm();
        });
        
        field.addEventListener('blur', () => {
          validateForm();
        });
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!validateForm()) {
          return;
        }

        // Hide previous errors
        const errorContainer = document.getElementById('error-container');
        errorContainer.classList.add('hidden');
        
        // Update button state
        submitBtn.textContent = 'Submitting...';
        submitBtn.classList.add('btn-disabled');
        isSubmitting = true;

        try {
          await saveQuizToSupabase();
          isSubmitting = false;
          clearState();
          showResult = true;
          render();
        } catch (error) {
          isSubmitting = false;
          
          // ‚úÖ Show error WITHOUT full re-render
          const errorMessage = document.getElementById('error-message');
          errorMessage.textContent = error.message || 'Connection failed. Please try again.';
          errorContainer.classList.remove('hidden');
          
          submitBtn.textContent = 'See My Journey ‚Üí';
          submitBtn.classList.remove('btn-disabled');
          
          // Scroll to error
          errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      });
      
      // Initial validation
      validateForm();
      return;
    }
  }

  function getRec() {
    const pilot = answers.pilot;
    return recommendations[pilot] || recommendations.ireland;
  }

  function renderResult() {
    const rec = getRec();
    const [testimonialText, testimonialAuthor = ''] = (rec.testimonial || '').split(' - ');
    
    root.innerHTML = `
      <div class="max-w-4xl mx-auto px-4 py-10 text-center fade-in">
        <div class="mb-8">
          <div class="text-6xl mb-4">${rec.flag}</div>
          <h1 class="text-3xl md:text-4xl font-bold mb-2">${esc(rec.title)}</h1>
          <p class="text-lg text-gray-300 italic">${esc(rec.tagline)}</p>
        </div>

        <div class="bg-white text-gray-900 rounded-2xl overflow-hidden mb-8 shadow-xl">
          <div class="p-6 space-y-6">
            <p class="text-lg">${esc(rec.description)}</p>

            <div>
              <h3 class="text-lg font-bold mb-3">Experience Highlights</h3>
              <ul class="space-y-2 text-left">
                ${rec.highlights.map(h => `
                  <li class="flex items-start gap-3">
                    <span class="text-[#e85d35] mt-0.5">‚úîÔ∏è</span>
                    <span>${esc(h)}</span>
                  </li>
                `).join('')}
              </ul>
            </div>

            <div>
              <h3 class="text-lg font-bold mb-3">What's Included</h3>
              <div class="flex flex-wrap gap-2 justify-center">
                ${rec.whatsIncluded.map(w => `
                  <span class="px-3 py-1 bg-gray-100 rounded-full text-xs font-medium">${esc(w)}</span>
                `).join('')}
              </div>
            </div>

            <div class="bg-[#1a1a2e] text-white p-4 rounded-xl">
              <p class="italic">"${esc(testimonialText)}"</p>
              <p class="text-sm text-gray-300 mt-1">- ${esc(testimonialAuthor)}</p>
            </div>

            <div class="space-y-3">
              <a href="https://travelbeyondthepitch.com" 
                class="block w-full text-center py-3 bg-[#e85d35] hover:bg-[#d14d25] rounded-xl font-bold text-white transition-all transform hover:scale-105">
                Book This Experience
              </a>
              <p class="text-center text-sm text-gray-600">
                Early access to new pilots with limited places
              </p>
            </div>
          </div>
        </div>

        <div class="text-gray-400 space-y-4">
          <p>Check your email for your complete personalized itinerary</p>
          <div class="flex flex-col sm:flex-row justify-center gap-4">
            <a href="https://travelbeyondthepitch.com" 
              class="text-[#e85d35] hover:underline">
              View All Experiences
            </a>
            <button id="retake-btn" 
              class="text-gray-400 hover:text-white transition">
              Retake Quiz
            </button>
          </div>
        </div>
      </div>
    `;
    
    document.getElementById('retake-btn')?.addEventListener('click', () => {
      currentStep = 0;
      Object.keys(answers).forEach(k => delete answers[k]);
      showResult = false;
      clearState();
      delete root.dataset.currentStepId; // Reset step tracking
      render();
    });
  }

  // Initialize
  loadState();
  render();

  // Debug helper
  window._BTP = { 
    steps, 
    answers, 
    goTo: goToStep,
    reset: () => {
      currentStep = 0;
      Object.keys(answers).forEach(k => delete answers[k]);
      showResult = false;
      clearState();
      delete root.dataset.currentStepId;
      render();
    }
  };
})();
</script>
</body>
</html>
