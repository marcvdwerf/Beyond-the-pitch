<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Beyond The Pitch - Discover Your Perfect Sport & Culture Journey</title>
  <meta name="description" content="Find your perfect authentic sport and culture experience. From Gaelic games in Ireland to football passion in Lima. Take our 3-minute quiz." />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { 
      -webkit-font-smoothing: antialiased; 
      -moz-osx-font-smoothing: grayscale; 
    }
    .card-selected { 
      border-color: #e85d35; 
      background: #FFF7F1; 
      box-shadow: 0 4px 12px rgba(232, 93, 53, 0.2);
    }
    .fade-in {
      animation: fadeIn 0.4s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .btn-disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }
    .pulse-subtle {
      animation: pulse-subtle 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    @keyframes pulse-subtle {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    /* Improved focus states for accessibility */
    button:focus-visible, input:focus-visible, select:focus-visible {
      outline: 2px solid #e85d35;
      outline-offset: 2px;
    }
  </style>
</head>
<body class="bg-[#1a1a2e] text-white min-h-screen">
<header class="max-w-4xl mx-auto px-4 py-4">
  <a href="https://travelbeyondthepitch.com" class="inline-flex items-center gap-3" aria-label="Travel Beyond The Pitch Home">
    <img 
      src="https://raw.githubusercontent.com/marcvdwerf/Beyond-the-pitch/refs/heads/main/images/beyond%20the%20pitch%20logo.jpg" 
      alt="Travel Beyond The Pitch"
      class="h-8 w-auto"
    />
  </a>
</header>

<div id="quiz-root" class="min-h-screen"></div>

<script>
(function () {
  const STORAGE_KEY = 'btp_quiz_state';
  const GOOGLE_FORM_URL = 'https://docs.google.com/forms/u/0/d/e/YOUR_FORM_ID/formResponse';
  
  // IMPORTANT: Replace these entry IDs with your own Google Form field IDs
  const FORM_FIELDS = {
    email: 'entry.123456789',
    age: 'entry.987654321',
    location: 'entry.456789123',
    pilot: 'entry.111222333',
    interests: 'entry.444555666',
    sport: 'entry.777888999',
    travelStyle: 'entry.101112131',
    group: 'entry.141516171',
    timing: 'entry.181920212',
    future: 'entry.232425262'
  };

  const root = document.getElementById('quiz-root');

  const steps = [
    {
      id: 'intro',
      type: 'intro',
      title: 'Discover Your Perfect Sport & Culture Journey',
      subtitle: 'Travel beyond the stadium. Dive into communities, traditions and untold stories.',
      description: 'Experience sport the way locals do‚Äîfrom ancient Gaelic games in Irish villages to the electric passion of Lima\'s football culture.',
      stat: 'Co-created with local clubs, fans and communities',
      benefits: [
        { icon: 'üéØ', text: 'Personalized destination matches' },
        { icon: 'üåç', text: 'Authentic local experiences' },
        { icon: 'ü§ù', text: 'Connect with real fans & communities' },
        { icon: '‚ú®', text: 'Exclusive early-bird access' }
      ]
    },
    {
      id: 'pilot',
      type: 'projects',
      title: 'Which destination speaks to you?',
      subtitle: 'Choose your adventure - each carefully crafted with local partners',
      options: [
        {
          value: 'ireland',
          country: 'Ireland',
          title: 'Gaelic Games',
          image: 'üáÆüá™',
          description: 'Ancient Irish sports, traditional pub culture, and rolling countryside',
          vibe: ['Authentic', 'Cultural', 'Community'],
          highlight: 'Experience hurling & Gaelic football with locals'
        },
        {
          value: 'lima',
          country: 'Peru',
          title: 'Alianza Lima',
          image: 'üáµüá™',
          description: 'South American football passion, world-class cuisine, and Pacific vibes',
          vibe: ['Vibrant', 'Passionate', 'Culinary'],
          highlight: 'Feel the intensity of Lima football culture'
        },
        {
          value: 'mongolia',
          country: 'Mongolia',
          title: 'Naadam Festival',
          image: 'üá≤üá≥',
          description: 'Wrestling, archery, horse racing in vast steppes with nomadic traditions',
          vibe: ['Epic', 'Adventurous', 'Unique'],
          highlight: 'Witness centuries-old warrior sports'
        }
      ]
    },
    {
      id: 'interests',
      type: 'multi-select',
      title: 'What makes travel meaningful to you?',
      subtitle: 'Select all that resonate (minimum 1)',
      options: [
        { value: 'sport', label: 'Live Sport', icon: '‚öΩ' },
        { value: 'food', label: 'Local Cuisine', icon: 'üçú' },
        { value: 'culture', label: 'Deep Culture', icon: 'üèõÔ∏è' },
        { value: 'nightlife', label: 'Nightlife', icon: 'üåô' },
        { value: 'locals', label: 'Meet Locals', icon: 'ü§ù' },
        { value: 'language', label: 'Language', icon: 'üí¨' },
        { value: 'nature', label: 'Nature', icon: 'üèîÔ∏è' },
        { value: 'photography', label: 'Photography', icon: 'üì∏' }
      ]
    },
    {
      id: 'sport',
      type: 'single-select',
      title: 'Your sport preference?',
      subtitle: 'What kind of sporting experience excites you most?',
      options: [
        { value: 'football-major', label: 'Football (Major Leagues)', desc: 'Top-tier clubs & stadiums' },
        { value: 'football-local', label: 'Football (Local Culture)', desc: 'Community clubs & authenticity' },
        { value: 'traditional', label: 'Traditional Sports', desc: 'Indigenous & cultural sports' },
        { value: 'basketball', label: 'Basketball', desc: 'NBA, EuroLeague, street culture' },
        { value: 'rugby', label: 'Rugby', desc: 'Six Nations, local clubs' },
        { value: 'combat', label: 'Combat Sports', desc: 'Boxing, MMA, traditional martial arts' },
        { value: 'open', label: 'Open to Anything', desc: 'Surprise me with unique experiences' }
      ]
    },
    {
      id: 'travelStyle',
      type: 'cards',
      title: 'Your travel style?',
      subtitle: 'Choose the experience level that fits you best',
      options: [
        { value: 'immersive', label: 'Immersive Explorer', icon: 'üéí', desc: 'Deep local experiences, authentic connections, budget-conscious', budget: '‚Ç¨400-700 per person' },
        { value: 'balanced', label: 'Balanced Adventurer', icon: 'üß≥', desc: 'Mix of comfort and local culture, curated experiences', budget: '‚Ç¨700-1200 per person' },
        { value: 'premium', label: 'Premium Traveler', icon: '‚ú®', desc: 'Comfort-first with exclusive access and personalized touches', budget: '‚Ç¨1200+ per person' }
      ]
    },
    {
      id: 'group',
      type: 'single-select',
      title: 'Who are you traveling with?',
      subtitle: 'Help us tailor the perfect group experience',
      options: [
        { value: 'solo', label: 'Solo', desc: 'Flying solo, open to meeting others' },
        { value: 'couple', label: 'Partner', desc: 'Traveling as a couple' },
        { value: 'friends', label: 'Friends Group', desc: '2-6 friends' },
        { value: 'family', label: 'Family', desc: 'Family adventure' },
        { value: 'corporate', label: 'Corporate/Team', desc: 'Team building or corporate trip' }
      ]
    },
    {
      id: 'timing',
      type: 'quick-select',
      title: 'When are you looking to travel?',
      subtitle: 'This helps us prioritize your match',
      options: [
        'Next 3 months',
        'Next 6 months',
        'This year',
        'Just exploring'
      ]
    },
    {
      id: 'future',
      type: 'multi-select',
      title: 'What would you love to see next?',
      subtitle: 'Help shape our future journeys (optional)',
      options: [
        { value: 'derbies', label: 'Football Derbies', icon: '‚öΩ' },
        { value: 'basketball', label: 'Basketball', icon: 'üèÄ' },
        { value: 'europe', label: 'Europe Rugby', icon: 'üèâ' },
        { value: 'balkans', label: 'Balkans', icon: 'üá∑üá∏' },
        { value: 'latam', label: 'Latin America', icon: 'üåé' },
        { value: 'africa', label: 'Africa', icon: 'üåç' },
        { value: 'asia', label: 'Central Asia', icon: 'üèîÔ∏è' },
        { value: 'traditional', label: 'Indigenous Sports', icon: 'üé™' }
      ],
      optional: true
    },
    {
      id: 'contact',
      type: 'email',
      title: 'Get Your Personalized Journey',
      subtitle: 'Receive your custom match + exclusive pilot access',
      fields: [
        { id: 'email', label: 'Email Address', type: 'email', required: true, placeholder: 'you@example.com' },
        { id: 'age', label: 'Age Range', type: 'select', required: true, options: ['18-24', '25-34', '35-44', '45-54', '55+'] },
        { id: 'location', label: 'Where are you from?', type: 'text', required: false, placeholder: 'City, Country' }
      ]
    }
  ];

  const recommendations = {
    ireland: {
      title: 'Ireland - Gaelic Games Experience',
      flag: 'üáÆüá™',
      tagline: 'Where Ancient Sport Meets Warm Hospitality',
      description: 'Based on your preferences, Ireland offers the perfect blend of authentic sport culture, community connection, and immersive local experiences.',
      highlights: [
        'Experience hurling and Gaelic football with local clubs',
        'Traditional pub sessions with players and locals',
        'Explore Irish countryside and coastal beauty',
        'Learn basic Irish phrases and sport terminology'
      ],
      whatsIncluded: ['Match tickets', 'Local guide', 'Traditional meals', 'Pub experiences', 'Cultural workshops'],
      testimonial: 'An unforgettable experience. The locals welcomed us like family. - Marc, Netherlands'
    },
    lima: {
      title: 'Lima - Alianza Lima Football',
      flag: 'üáµüá™',
      tagline: 'Where Football Passion Fuels a City',
      description: 'Your answers point to Lima - a destination where intense football culture meets world-renowned cuisine and vibrant nightlife.',
      highlights: [
        "Feel the electricity of South American football",
        "Culinary tour through Lima's food scene",
        "Experience Peruvian nightlife with locals",
        "Visit historic neighborhoods and markets"
      ],
      whatsIncluded: ['Stadium experience', 'Food tours', 'Local host', 'City exploration', 'Nightlife access'],
      testimonial: 'The passion at the stadium gave me goosebumps everytime. Lima exceeded all expectations. - Jos√©, Local guide and lifelong Alianza fan'
    },
    mongolia: {
      title: 'Mongolia - Naadam Festival',
      flag: 'üá≤üá≥',
      tagline: 'An Epic Journey Into Warrior Traditions',
      description: "You are drawn to the extraordinary. Mongolia's Naadam Festival offers an adventure unlike anything else - ancient sports in vast landscapes.",
      highlights: [
        'Witness traditional wrestling, archery, and horse racing',
        'Stay with nomadic families in the steppe',
        'Experience centuries-old warrior culture',
        'Explore Ulaanbaatar and endless grasslands'
      ],
      whatsIncluded: ['Festival access', 'Nomadic homestay', 'Cultural guide', 'Traditional meals', 'Nature experiences'],
      testimonial: 'Life-changing. The festival and landscapes are beyond words. - Thomas, Germany'
    }
  };

  let currentStep = 0;
  const answers = {};
  let isSubmitting = false;
  let showResult = false;
  let submitError = null;

  // Load saved state
  function loadState() {
    try {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        const state = JSON.parse(saved);
        Object.assign(answers, state.answers || {});
        currentStep = state.currentStep || 0;
      }
    } catch (e) {
      console.error('Failed to load state:', e);
    }
  }

  // Save state
  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        answers,
        currentStep,
        timestamp: Date.now()
      }));
    } catch (e) {
      console.error('Failed to save state:', e);
    }
  }

  // Clear state
  function clearState() {
    try {
      localStorage.removeItem(STORAGE_KEY);
    } catch (e) {
      console.error('Failed to clear state:', e);
    }
  }

  function progressPercent() {
    const totalSteps = steps.length - 2; // Exclude intro and contact
    const current = Math.max(0, currentStep - 1);
    return Math.round((current / totalSteps) * 100);
  }

  function canProceedForStep(step) {
    if (!step) return false;
    if (step.type === 'intro') return true;
    if (step.type === 'email') {
      return answers.email && isValidEmail(answers.email) && answers.age;
    }
    if (step.type === 'multi-select') {
      // Optional multi-select steps can be skipped
      if (step.optional) return true;
      return Array.isArray(answers[step.id]) && answers[step.id].length > 0;
    }
    return answers[step.id] !== undefined && answers[step.id] !== null && answers[step.id] !== '';
  }

  function isValidEmail(email) {
    return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
  }

  function esc(s) { 
    return String(s || '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[c])); 
  }

  async function submitToGoogleForms() {
    const formData = new FormData();
    
    // Map answers to Google Form fields
    Object.keys(FORM_FIELDS).forEach(key => {
      const value = answers[key];
      if (value !== undefined && value !== null) {
        if (Array.isArray(value)) {
          formData.append(FORM_FIELDS[key], value.join(', '));
        } else {
          formData.append(FORM_FIELDS[key], value);
        }
      }
    });

    try {
      // Submit to Google Forms
      await fetch(GOOGLE_FORM_URL, {
        method: 'POST',
        mode: 'no-cors',
        body: formData
      });
      
      return { success: true };
    } catch (error) {
      console.error('Submission error:', error);
      return { success: false, error: error.message };
    }
  }

  function goToStep(stepIndex) {
    if (stepIndex < 0 || stepIndex >= steps.length) return;
    currentStep = stepIndex;
    saveState();
    render();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function nextStep() {
    goToStep(currentStep + 1);
  }

  function prevStep() {
    goToStep(currentStep - 1);
  }

  // Render architecture: one shell with dynamic updates
  let shellBuilt = false;
  let el = {}; // references to frequently used elements

  function buildShell() {
    root.innerHTML = `
      <div class="max-w-4xl mx-auto px-4 py-8 fade-in" id="btp-container">
        <div id="btp-progress" class="mb-6" style="display:none;">
          <div class="flex justify-between items-center mb-3">
            <span class="text-xs text-gray-400" id="btp-progress-text">Step 0 of 0</span>
            <span class="text-xs text-gray-400" id="btp-progress-percent">0%</span>
          </div>
          <div class="w-full bg-gray-700 rounded-full h-2">
            <div id="btp-progress-bar" class="bg-[#e85d35] h-2 rounded-full transition-all duration-300" style="width:0%"></div>
          </div>
        </div>

        <div id="btp-card" class="bg-white text-gray-900 rounded-2xl p-6 md:p-8 mb-6 shadow-xl">
          <div class="mb-6">
            <h2 class="text-2xl md:text-3xl font-bold mb-2" id="btp-title"></h2>
            <p class="text-sm md:text-base text-gray-600" id="btp-subtitle"></p>
          </div>

          <div id="step-content"></div>
        </div>

        <div id="step-controls" class="flex items-center gap-4"></div>
      </div>
    `;

    el.container = document.getElementById('btp-container');
    el.progress = document.getElementById('btp-progress');
    el.progressText = document.getElementById('btp-progress-text');
    el.progressPercent = document.getElementById('btp-progress-percent');
    el.progressBar = document.getElementById('btp-progress-bar');
    el.card = document.getElementById('btp-card');
    el.title = document.getElementById('btp-title');
    el.subtitle = document.getElementById('btp-subtitle');
    el.content = document.getElementById('step-content');
    el.controls = document.getElementById('step-controls');

    shellBuilt = true;
  }

  function render() {
    if (!shellBuilt) buildShell();

    if (showResult) {
      renderResult();
      return;
    }

    const step = steps[currentStep];
    if (!step) return;

    const showProgress = step.type !== 'intro';
    el.progress.style.display = showProgress ? 'block' : 'none';
    el.progressText.textContent = `Step ${currentStep} of ${steps.length - 1}`;
    el.progressPercent.textContent = `${progressPercent()}%`;
    el.progressBar.style.width = `${progressPercent()}%`;

    const canGoBack = currentStep > 1;

    // Update title/subtitle
    el.title.innerHTML = esc(step.title);
    el.subtitle.innerHTML = step.subtitle ? esc(step.subtitle) : '';

    // Update controls (back button)
    el.controls.innerHTML = canGoBack ? `
      <button id="back-btn" class="px-6 py-3 bg-gray-700 hover:bg-gray-600 rounded-xl font-semibold transition">
        ‚Üê Back
      </button>
    ` : '';

    if (canGoBack) {
      el.controls.querySelector('#back-btn').addEventListener('click', prevStep);
    }

    // Render step content
    renderStepContent(step, el.content);
  }

  function renderStepContent(step, content) {
    if (step.type === 'intro') {
      content.innerHTML = `
        <div class="text-center space-y-6">
          <p class="text-xl md:text-2xl text-gray-700 font-light leading-relaxed">
            ${esc(step.subtitle)}
          </p>
          
          <p class="text-base text-gray-600 max-w-2xl mx-auto">
            ${esc(step.description)}
          </p>

          <div class="flex items-center justify-center gap-3 text-gray-500 py-4">
            <div class="text-3xl">üèÜ</div>
            <span class="text-sm font-medium">${esc(step.stat)}</span>
          </div>

          <!-- NEW: Value proposition boxes -->
          <div class="grid grid-cols-2 md:grid-cols-4 gap-4 py-6 max-w-3xl mx-auto">
            ${step.benefits.map(b => `
              <div class="text-center">
                <div class="text-3xl mb-2">${b.icon}</div>
                <div class="text-xs text-gray-600 font-medium">${esc(b.text)}</div>
              </div>
            `).join('')}
          </div>

          <div class="pt-4">
            <button id="begin-btn" class="px-10 py-4 bg-[#e85d35] hover:bg-[#d14d25] rounded-xl font-bold text-white text-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">
              Start Your Journey ‚Üí
            </button>
            <p class="text-sm text-gray-400 mt-4">Takes 2-3 minutes ‚Ä¢ 9 simple questions</p>
          </div>

          <!-- NEW: Pilot badge -->
          <div class="pt-6 border-t border-gray-200 mt-8">
            <div class="inline-flex items-center gap-2 px-4 py-2 bg-orange-50 rounded-full">
              <span class="text-xs font-semibold text-[#e85d35]">üöÄ PILOT PROGRAM</span>
              <span class="text-xs text-gray-600">Limited spots available</span>
            </div>
          </div>
        </div>
      `;
      content.querySelector('#begin-btn').addEventListener('click', nextStep);
      return;
    }

    if (step.type === 'projects') {
      content.innerHTML = step.options.map(opt => {
        const selected = answers[step.id] === opt.value;
        return `
          <button type="button" data-value="${esc(opt.value)}" 
            class="w-full text-left p-5 rounded-xl mb-4 transition-all border-2 hover:shadow-lg ${selected ? 'card-selected' : 'border-gray-200 hover:border-gray-300'}">
            <div class="flex items-start gap-4">
              <div class="text-5xl flex-shrink-0">${opt.image}</div>
              <div class="flex-1">
                <div class="flex items-center gap-2 mb-2">
                  <h3 class="font-bold text-lg">${esc(opt.country)}</h3>
                  <span class="text-sm text-[#e85d35] font-semibold">${esc(opt.title)}</span>
                </div>
                <p class="text-sm text-gray-600 mb-3">${esc(opt.description)}</p>
                <div class="flex gap-2 flex-wrap mb-2">
                  ${opt.vibe.map(t => `<span class="px-3 py-1 bg-gray-100 rounded-full text-xs text-gray-800 font-medium">${esc(t)}</span>`).join('')}
                </div>
                <p class="text-xs text-gray-500 italic mt-2">‚ú® ${esc(opt.highlight)}</p>
              </div>
            </div>
          </button>
        `;
      }).join('');

      content.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener('click', () => {
          answers[step.id] = btn.getAttribute('data-value');
          saveState();
          renderStepContent(step, content);
          setTimeout(nextStep, 300);
        });
      });
      return;
    }

    if (step.type === 'multi-select') {
      const canProceed = canProceedForStep(step);
      content.innerHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6" id="multi-grid">
          ${step.options.map(opt => {
            const selected = Array.isArray(answers[step.id]) && answers[step.id].includes(opt.value);
            return `
              <button type="button" data-value="${esc(opt.value)}" 
                class="p-4 border-2 rounded-xl text-center transition-all hover:shadow-md ${selected ? 'card-selected' : 'border-gray-200 hover:border-gray-300'}">
                <div class="text-3xl mb-2">${opt.icon}</div>
                <div class="text-sm font-medium">${esc(opt.label)}</div>
              </button>
            `;
          }).join('')}
        </div>

        <button id="multi-continue" 
          class="w-full py-4 bg-[#e85d35] hover:bg-[#d14d25] rounded-xl text-white font-bold transition-all shadow-md hover:shadow-lg ${canProceed ? '' : 'btn-disabled'}">
          Continue ‚Üí
        </button>
        ${step.optional ? '<p class="text-xs text-gray-500 text-center mt-3">Optional - you can skip this</p>' : ''}
      `;

      content.querySelectorAll('#multi-grid button').forEach(btn => {
        btn.addEventListener('click', () => {
          const v = btn.getAttribute('data-value');
          const arr = Array.isArray(answers[step.id]) ? [...answers[step.id]] : [];
          const idx = arr.indexOf(v);
          if (idx >= 0) arr.splice(idx, 1);
          else arr.push(v);
          answers[step.id] = arr;
          saveState();
          renderStepContent(step, content);
        });
      });

      content.querySelector('#multi-continue')?.addEventListener('click', () => {
        if (canProceedForStep(step)) nextStep();
      });
      return;
    }

    if (step.type === 'single-select') {
      content.innerHTML = step.options.map(opt => {
        const selected = answers[step.id] === opt.value;
        return `
          <button type="button" data-value="${esc(opt.value)}" 
            class="w-full p-5 rounded-xl mb-3 text-left border-2 transition-all hover:shadow-md ${selected ? 'card-selected' : 'border-gray-200 hover:border-gray-300'}">
            <div class="font-semibold text-base mb-1">${esc(opt.label)}</div>
            <div class="text-sm text-gray-600">${esc(opt.desc)}</div>
          </button>
        `;
      }).join('');

      content.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener('click', () => {
          answers[step.id] = btn.getAttribute('data-value');
          saveState();
          renderStepContent(step, content);
          setTimeout(nextStep, 300);
        });
      });
      return;
    }

    if (step.type === 'cards') {
      content.innerHTML = `
        <div class="grid md:grid-cols-3 gap-4">
          ${step.options.map(opt => {
            const selected = answers[step.id] === opt.value;
            return `
              <button type="button" data-value="${esc(opt.value)}" 
                class="p-5 rounded-xl text-center border-2 transition-all hover:shadow-lg ${selected ? 'card-selected' : 'border-gray-200 hover:border-gray-300'}">
                <div class="text-4xl mb-3">${opt.icon}</div>
                <div class="font-bold text-base mb-2">${esc(opt.label)}</div>
                <div class="text-sm text-gray-600 mb-3 min-h-[60px]">${esc(opt.desc)}</div>
                <div class="text-xs font-semibold text-[#e85d35] bg-orange-50 py-2 px-3 rounded-lg">${esc(opt.budget)}</div>
              </button>
            `;
          }).join('')}
        </div>
      `;

      content.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener('click', () => {
          answers[step.id] = btn.getAttribute('data-value');
          saveState();
          renderStepContent(step, content);
          setTimeout(nextStep, 300);
        });
      });
      return;
    }

    if (step.type === 'quick-select') {
      content.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          ${step.options.map(opt => {
            const selected = answers[step.id] === opt;
            return `
              <button type="button" data-value="${esc(opt)}" 
                class="p-5 border-2 rounded-xl font-semibold text-base transition-all hover:shadow-md ${selected ? 'card-selected' : 'border-gray-200 hover:border-gray-300'}">
                ${esc(opt)}
              </button>
            `;
          }).join('')}
        </div>
      `;

      content.querySelectorAll('button[data-value]').forEach(btn => {
        btn.addEventListener('click', () => {
          answers[step.id] = btn.getAttribute('data-value');
          saveState();
          renderStepContent(step, content);
          setTimeout(nextStep, 300);
        });
      });
      return;
    }

    if (step.type === 'email') {
      content.innerHTML = `
        <div class="bg-orange-50 border-l-4 border-[#e85d35] p-5 rounded-lg mb-6">
          <div class="flex items-start gap-3">
            <div class="text-2xl">‚ú®</div>
            <div>
              <div class="font-bold text-[#e85d35] mb-1">What you'll receive:</div>
              <ul class="text-sm text-gray-700 space-y-1">
                <li>‚úì Your personalized destination match</li>
                <li>‚úì Detailed itinerary preview</li>
                <li>‚úì Exclusive pilot pricing & early-bird access</li>
                <li>‚úì Direct contact with your travel specialist</li>
              </ul>
            </div>
          </div>
        </div>

        ${submitError ? `
          <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg mb-4">
            <div class="font-semibold text-red-800">Something went wrong</div>
            <div class="text-sm text-red-600">${esc(submitError)}</div>
          </div>
        ` : ''}

        <form id="contact-form" class="space-y-5">
          ${step.fields.map(f => {
            const value = answers[f.id] || '';
            const hasError = f.required && f.id === 'email' && value && !isValidEmail(value);
            
            if (f.type === 'select') {
              return `
                <div>
                  <label class="block text-sm font-semibold mb-2">${esc(f.label)} ${f.required ? '<span class="text-red-500">*</span>' : ''}</label>
                  <select name="${esc(f.id)}" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-base focus:border-[#e85d35] focus:outline-none transition border-gray-300">
                    <option value="">Select...</option>
                    ${f.options.map(opt => `
                      <option value="${esc(opt)}" ${value === opt ? 'selected' : ''}>${esc(opt)}</option>
                    `).join('')}
                  </select>
                </div>
              `;
            } else {
              return `
                <div>
                  <label class="block text-sm font-semibold mb-2">${esc(f.label)} ${f.required ? '<span class="text-red-500">*</span>' : ''}</label>
                  <input name="${esc(f.id)}" type="${esc(f.type)}" 
                    value="${esc(value)}"
                    placeholder="${esc(f.placeholder || '')}" 
                    class="w-full px-4 py-3 border-2 rounded-xl text-base focus:border-[#e85d35] focus:outline-none transition ${hasError ? 'border-red-500' : 'border-gray-300'}" />
                  ${hasError ? '<p class="text-xs text-red-500 mt-2">Please enter a valid email address</p>' : ''}
                </div>
              `;
            }
          }).join('')}

          <button type="submit" id="submit-btn" 
            class="w-full py-4 bg-[#e85d35] hover:bg-[#d14d25] rounded-xl text-white font-bold text-lg transition-all shadow-lg hover:shadow-xl ${canProceedForStep(step) && !isSubmitting ? '' : 'btn-disabled'}">
            ${isSubmitting ? 'Sending...' : 'Show Me My Journey ‚Üí'}
          </button>
          
          <p class="text-xs text-gray-500 text-center mt-4">
            üîí We respect your privacy. Only personalized travel recommendations. No spam. Unsubscribe anytime.
          </p>
        </form>
      `;

      const form = content.querySelector('#contact-form');
      
      // Real-time validation
      form.querySelectorAll('input, select').forEach(field => {
        field.addEventListener('input', (e) => {
          const fieldId = e.target.name;
          answers[fieldId] = e.target.value.trim();
          saveState();
          
          // Re-render to update button state and validation
          if (fieldId === 'email' || fieldId === 'age') {
            render();
          } else {
            const submitBtn = content.querySelector('#submit-btn');
            if (submitBtn) {
              if (canProceedForStep(step) && !isSubmitting) submitBtn.classList.remove('btn-disabled');
              else submitBtn.classList.add('btn-disabled');
            }
          }
        });
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const fd = new FormData(form);
        let missing = false;
        
        step.fields.forEach(f => {
          const v = fd.get(f.id);
          if (f.required && (!v || v.trim() === '')) {
            missing = true;
          }
          if (f.id === 'email' && v && !isValidEmail(v)) {
            missing = true;
          }
          answers[f.id] = v ? v.trim() : '';
        });

        if (missing) {
          submitError = 'Please fill in all required fields correctly.';
          render();
          return;
        }

        isSubmitting = true;
        submitError = null;
        render();

        const result = await submitToGoogleForms();
        
        isSubmitting = false;
        
        if (result.success) {
          clearState();
          showResult = true;
          render();
        } else {
          submitError = 'Connection failed. Please try again.';
          render();
        }
      });
      return;
    }
  }

  function getRec() {
    const pilot = answers.pilot;
    return recommendations[pilot] || recommendations.ireland;
  }

  function renderResult() {
    const rec = getRec();
    const [testimonialText, testimonialAuthor = ''] = (rec.testimonial || '').split(' - ');
    
    el.progress.style.display = 'none';
    el.controls.innerHTML = '';

    el.title.innerHTML = `<span class="text-2xl">${rec.flag}</span> ${esc(rec.title)}`;
    el.subtitle.innerHTML = `<span class="text-base text-gray-600 italic">${esc(rec.tagline)}</span>`;

    el.content.innerHTML = `
      <div class="space-y-6 fade-in">
        <div class="bg-gradient-to-r from-orange-50 to-yellow-50 p-6 rounded-xl border-2 border-orange-200">
          <div class="flex items-start gap-3 mb-3">
            <div class="text-3xl">üéØ</div>
            <div>
              <div class="font-bold text-lg text-gray-900 mb-1">Your Perfect Match</div>
              <p class="text-gray-700">${esc(rec.description)}</p>
            </div>
          </div>
        </div>

        <div>
          <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span>‚ú®</span> Experience Highlights
          </h3>
          <ul class="space-y-3">
            ${rec.highlights.map(h => `
              <li class="flex items-start gap-3 bg-gray-50 p-3 rounded-lg">
                <span class="text-[#e85d35] mt-0.5 text-xl flex-shrink-0">‚úîÔ∏è</span>
                <span class="text-gray-800">${esc(h)}</span>
              </li>
            `).join('')}
          </ul>
        </div>

        <div>
          <h3 class="text-xl font-bold mb-4 flex items-center gap-2">
            <span>üì¶</span> What's Included
          </h3>
          <div class="flex flex-wrap gap-2">
            ${rec.whatsIncluded.map(w => `
              <span class="px-4 py-2 bg-[#e85d35] text-white rounded-full text-sm font-medium">${esc(w)}</span>
            `).join('')}
          </div>
        </div>

        <div class="bg-[#1a1a2e] text-white p-6 rounded-xl">
          <div class="text-4xl mb-3 text-center">üí¨</div>
          <p class="italic text-lg text-center mb-2">"${esc(testimonialText)}"</p>
          <p class="text-sm text-gray-300 text-center">‚Äî ${esc(testimonialAuthor)}</p>
        </div>

        <div class="space-y-4 pt-4">
          <a href="https://travelbeyondthepitch.com/contact" 
            class="block w-full text-center py-4 bg-[#e85d35] hover:bg-[#d14d25] rounded-xl font-bold text-white text-lg transition-all transform hover:scale-105 shadow-lg hover:shadow-xl">
            Book This Experience
          </a>
          
          <div class="bg-green-50 border-2 border-green-200 p-4 rounded-xl text-center">
            <div class="font-bold text-green-800 mb-1">‚úÖ Check Your Email</div>
            <div class="text-sm text-green-700">Your complete personalized itinerary has been sent</div>
          </div>

          <p class="text-center text-sm text-gray-600 px-4">
            üöÄ Early pilot access ‚Ä¢ Limited spots ‚Ä¢ Exclusive pricing
          </p>
        </div>

        <div class="border-t pt-6 mt-6 text-center space-y-4">
          <div class="flex flex-col sm:flex-row justify-center gap-4 text-sm">
            <a href="https://travelbeyondthepitch.com" 
              class="text-[#e85d35] hover:underline font-semibold">
              Explore All Experiences
            </a>
            <button id="retake-btn" 
              class="text-gray-600 hover:text-gray-900 transition font-semibold">
              Retake Quiz
            </button>
          </div>
        </div>
      </div>
    `;
    
    el.content.querySelector('#retake-btn')?.addEventListener('click', () => {
      currentStep = 0;
      Object.keys(answers).forEach(k => delete answers[k]);
      showResult = false;
      clearState();
      render();
    });
  }

  // Initialize
  loadState();
  buildShell();
  render();

  // Debug helper
  window._BTP = { 
    steps, 
    answers, 
    goTo: goToStep,
    reset: () => {
      currentStep = 0;
      Object.keys(answers).forEach(k => delete answers[k]);
      showResult = false;
      clearState();
      render();
    }
  };
})();
</script>
</body>
</html>
